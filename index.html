<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Work Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0a0a0a;
        --fg: #e9e9ea;
        --muted: #a0a3a8;
        --card: #121214;
        --border: #222327;
        --weekend: #2c2d33;
        --done: #22c55e;
        --holiday-bg: #211214;
        --holiday-border: #3a1c21;

        /* Десктопные базовые размеры */
        --gap: 6px; /* gap ХЕДЕРА */
        --gap-grid: 6px; /* gap СЕТКИ (отдельно!) */
        --size: 54px; /* диаметр кружков ХЕДЕРА (у нас в хедере только текст, но оставляю как было) */
        --size-grid: 54px; /* диаметр кружков в СЕТКЕ */
        --num-font: 18px;
        --icon-font: 28px;
        --datefont: 11px;
        --radius: 999px;
        --maxw: 1000px;

        --leftcol: 130px; /* ширина колонки «Weekly earnings» в ХЕДЕРЕ */
        --leftcol-grid: 130px; /* ширина колонки «Weekly earnings» в СЕТКЕ */

        --bar-bg: #101115;
        --bar-border: #23242a;

        --shadow: 0 6px 16px rgba(0, 0, 0, 0.28);
        --subtle: rgba(255, 255, 255, 0.06);

        --today-ring: #f5d34c;

        --sticky-bg: rgba(12, 12, 12, 0.92);
        --sticky-border: #161616;
        --sticky-shadow: 0 10px 22px rgba(0, 0, 0, 0.22);
        --sticky-inset: inset 0 1px 0 rgba(255, 255, 255, 0.02);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        overflow-x: hidden;
      } /* железная страховка от горизонтального скролла */
      body {
        margin: 0;
        color: var(--fg);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial, sans-serif;
        display: flex;
        justify-content: center;
        padding: 0 12px 40px;

        /* тёмный фон */
        background-color: var(--bg);
        background-image: radial-gradient(
            1200px 900px at 50% 10%,
            rgba(255, 255, 255, 0.03),
            transparent 60%
          ),
          linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.02) 0%,
            rgba(0, 0, 0, 0) 40%,
            rgba(255, 255, 255, 0.02) 60%,
            rgba(0, 0, 0, 0) 100%
          ),
          radial-gradient(
            1000px 700px at 78% 12%,
            rgba(62, 99, 255, 0.08),
            transparent 65%
          ),
          radial-gradient(
            900px 650px at 15% 5%,
            rgba(161, 71, 255, 0.06),
            transparent 60%
          ),
          url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='320' height='320' viewBox='0 0 320 320'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 0.03'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>");
        background-repeat: no-repeat, no-repeat, no-repeat, no-repeat, repeat;
        background-position: center top, center, right top, left top, 0 0;
        background-size: cover, 200% 200%, 120% 120%, 130% 130%, 320px 320px;
      }

      .wrap {
        width: min(var(--maxw), 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 8px;
      }

      /* ── Sticky header (оставляем как есть по размерам) ─────────────── */
      .sticky {
        position: sticky;
        top: 0;
        z-index: 50;
        background: var(--sticky-bg);
        border: 1px solid var(--sticky-border);
        border-radius: 14px;
        box-shadow: var(--sticky-shadow), var(--sticky-inset);
        margin-top: 8px;
        width: 100%;
        max-width: var(--maxw);
      }
      .sticky-inner {
        padding: 14px 18px 12px;
      }

      .progress {
        margin-bottom: 10px;
      }
      .progress-top {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 13px;
        color: var(--muted);
      }
      .progress-nums,
      .earn-total {
        font-variant-numeric: tabular-nums;
        color: #fff;
        font-weight: 700;
      }
      .bar {
        width: 100%;
        height: 10px;
        background: var(--bar-bg);
        border: 1px solid var(--bar-border);
        border-radius: 999px;
        overflow: hidden;
        box-shadow: inset 0 1px 0 var(--subtle);
      }
      .bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        transition: width 0.35s ease;
      }

      /* Weekday row (в хедере) */
      .header {
        display: grid;
        grid-template-columns: var(--leftcol) repeat(7, 1fr);
        gap: var(--gap);
        user-select: none;
        padding-top: 6px;
        justify-items: stretch;
        width: 100%;
        max-width: var(--maxw);
      }
      .weekday {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.3px;
        padding: 2px 0;
      }
      .weekhead {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0;
      }

      /* ── GRID ниже хедера (адаптируем отдельно!) ───────────────────── */
      .grid {
        display: grid;
        grid-template-columns: var(--leftcol-grid) repeat(7, 1fr);
        gap: var(--gap-grid);
        padding-top: 12px;
        justify-items: stretch;
        width: 100%;
        max-width: var(--maxw);
      }

      .earn-cell {
        width: 100%;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, #151517, #101012);
        border-radius: 12px;
        padding: 10px 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: calc(var(--size-grid) + 22px);
        box-shadow: var(--shadow);
      }
      .earn-val {
        width: 100%;
        color: #fff;
        font-weight: 800;
        font-variant-numeric: tabular-nums;
        font-size: 14px;
        text-align: center;
        letter-spacing: 0.2px;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.25);
        white-space: nowrap;
      }
      .earn-bar {
        width: 100%;
        height: 6px;
        background: var(--bar-bg);
        border: 1px solid var(--bar-border);
        border-radius: 999px;
        overflow: hidden;
      }
      .earn-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        transition: width 0.35s ease;
      }

      .cell {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: calc(var(--size-grid) + 22px);
      }
      .circle {
        width: var(--size-grid);
        height: var(--size-grid);
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        line-height: 1;
        user-select: none;
        font-size: var(--num-font);
        transition: background 0.2s, color 0.2s, border-color 0.2s,
          transform 0.1s, box-shadow 0.2s;
        box-shadow: var(--shadow);
        max-width: 100%;
      }
      .circle:hover {
        transform: translateY(-1px);
      }
      .today .circle {
        outline: 2px solid var(--today-ring);
        outline-offset: 2px;
        box-shadow: 0 0 0 3px rgba(245, 211, 76, 0.12), var(--shadow);
      }
      .date {
        margin-top: 6px;
        font-size: var(--datefont);
        color: var(--muted);
        line-height: 1;
        user-select: none;
      }

      .weekend .circle {
        background: var(--weekend);
        color: #d0d0d0;
        border-color: #47484f;
      }
      .weekend .circle:hover {
        transform: none;
      }

      .holiday .circle {
        background: var(--holiday-bg);
        border-color: var(--holiday-border);
        color: #fff;
        font-size: var(--icon-font);
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
      }

      .done .circle {
        background: var(--done);
        color: #0c2618;
        border-color: var(--done);
        font-size: var(--icon-font);
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
      }

      .circle:focus-visible {
        outline: 2px solid #5ab0ff;
        outline-offset: 3px;
      }

      /* ── RESPONSIVE ─────────────────────────────────────────────────── */

      /* лёгкая адаптация планшетов — хедер остаётся прежним */
      @media (max-width: 800px) {
        :root {
          --leftcol: 120px;
        }
        :root {
          --leftcol-grid: 120px;
        }
      }

      /* КЛЮЧ: ЖЁСТКИЙ МОБИЛЬНЫЙ АДАПТИВ ТОЛЬКО ДЛЯ СЕТКИ НИЖЕ ХЕДЕРА */
      /* Обычные iPhone (390–430px) и ниже */
      @media (max-width: 480px) {
        :root {
          /* хедер НЕ меняем */
          --gap: 6px;
          --leftcol: 130px;

          /* сетка: ужимаем отдельно */
          --leftcol-grid: clamp(78px, 22vw, 100px);
          --gap-grid: clamp(2px, 1vw, 4px);

          /* диаметр кружка из ширины экрана:
           100vw - (боковые поля body ~ 24px + внутренние .wrap ~ 16px) - левая колонка - 6 промежутков */
          --size-grid: clamp(
            24px,
            calc(
              (100vw - 40px - var(--leftcol-grid) - (7 - 1) * var(--gap-grid)) /
                7
            ),
            40px
          );

          /* тексты поменьше */
          --num-font: clamp(12px, 3.4vw, 16px);
          --icon-font: clamp(18px, 5.2vw, 22px);
          --datefont: clamp(9px, 2.7vw, 11px);
        }
        /* уменьшаем только внешние поля сетки (хедер не трогаем) */
        .wrap {
          padding: 0 6px;
        }
        .grid {
          padding-top: 10px;
        }
        .bar {
          height: 8px;
        }
      }

      /* Очень узкие iPhone (≤390px) */
      @media (max-width: 390px) {
        :root {
          --leftcol-grid: clamp(70px, 21vw, 92px);
          --gap-grid: clamp(2px, 0.9vw, 3px);
          --size-grid: clamp(
            22px,
            calc(
              (100vw - 36px - var(--leftcol-grid) - (7 - 1) * var(--gap-grid)) /
                7
            ),
            36px
          );
          --num-font: clamp(11px, 3.2vw, 15px);
          --icon-font: clamp(16px, 5vw, 20px);
          --datefont: clamp(9px, 2.8vw, 10px);
        }
        .wrap {
          padding: 0 4px;
        }
        .sticky {
          border-radius: 12px;
        }
      }

      /* Совсем узкие (≤340px) */
      @media (max-width: 340px) {
        :root {
          --leftcol-grid: clamp(64px, 20vw, 86px);
          --gap-grid: 2px;
          --size-grid: clamp(
            20px,
            calc(
              (100vw - 32px - var(--leftcol-grid) - (7 - 1) * var(--gap-grid)) /
                7
            ),
            32px
          );
          --num-font: clamp(10px, 3vw, 14px);
          --icon-font: clamp(14px, 4.8vw, 18px);
          --datefont: 9px;
        }
        .sticky-inner {
          padding: 10px 10px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap" aria-label="Work calendar">
      <!-- Sticky header (идеального размера, не меняем) -->
      <div class="sticky">
        <div class="sticky-inner">
          <div class="progress" aria-live="polite">
            <div class="progress-top">
              <div>Progress (working days only)</div>
              <div class="earn-total" id="earnTotal">$0</div>
              <div class="progress-nums" id="progressNums">0/0 (0%)</div>
            </div>
            <div
              class="bar"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-valuenow="0"
              aria-label="Workdays progress"
            >
              <div class="bar-fill" id="barFill" style="width: 0%"></div>
            </div>
          </div>

          <div class="header" aria-hidden="true">
            <div class="weekhead">Weekly earnings</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>
            <div class="weekday">Sun</div>
          </div>
        </div>
      </div>

      <!-- Grid (адаптивная отдельно от хедера) -->
      <div id="grid" class="grid"></div>
    </div>

    <script>
      const TZ = "America/New_York";
      const DAILY_RATE = 125;

      // Видимый диапазон
      const start = new Date("2025-10-06T00:00:00"); // Mon
      const endDisplay = new Date("2026-03-01T00:00:00"); // Sun
      // Рабочие/оплачиваемые считаем до 27 Feb 2026
      const workEnd = new Date("2026-02-27T00:00:00");

      const HOLIDAYS_ALL = new Set([
        "2025-11-27",
        "2025-11-28",
        "2025-12-25",
        "2025-12-26",
        "2026-01-01",
        "2026-01-02",
        "2025-12-15",
      ]);
      const PAID_DAYS = new Set(["2025-11-27", "2025-12-25", "2026-01-01"]);

      const grid = document.getElementById("grid");
      const barFill = document.getElementById("barFill");
      const progressNums = document.getElementById("progressNums");
      const earnTotalEl = document.getElementById("earnTotal");

      const fmtTooltip = new Intl.DateTimeFormat("en-US", {
        weekday: "short",
        month: "short",
        day: "2-digit",
        year: "numeric",
        timeZone: TZ,
      });
      const fmtDay = new Intl.DateTimeFormat("en-US", {
        day: "2-digit",
        timeZone: TZ,
      });
      const fmtMonth = new Intl.DateTimeFormat("en-US", {
        month: "short",
        timeZone: TZ,
      });

      function ymdInNY(d) {
        const parts = new Intl.DateTimeFormat("en-CA", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          timeZone: TZ,
        }).formatToParts(d);
        const y = parts.find((p) => p.type === "year").value;
        const m = parts.find((p) => p.type === "month").value;
        const da = parts.find((p) => p.type === "day").value;
        return `${y}-${m}-${da}`;
      }
      function nowInNY() {
        return new Date(new Date().toLocaleString("en-US", { timeZone: TZ }));
      }

      // Строим дни
      const allDays = [];
      for (
        let d = new Date(start);
        d <= endDisplay;
        d.setDate(d.getDate() + 1)
      ) {
        allDays.push(new Date(d));
      }

      // По неделям (Mon..Sun)
      const weeks = [];
      for (let i = 0; i < allDays.length; i += 7)
        weeks.push(allDays.slice(i, i + 7));

      const workdayCells = [];
      const payableCells = [];
      const weekModels = [];

      // Рендер
      weeks.forEach((weekDays) => {
        const earnCell = document.createElement("div");
        earnCell.className = "earn-cell";

        const earnVal = document.createElement("div");
        earnVal.className = "earn-val";
        earnVal.textContent = "$0 / $0";

        const earnBar = document.createElement("div");
        earnBar.className = "earn-bar";
        const earnFill = document.createElement("div");
        earnFill.className = "earn-fill";
        earnBar.appendChild(earnFill);

        earnCell.appendChild(earnVal);
        earnCell.appendChild(earnBar);
        grid.appendChild(earnCell);

        const model = {
          earnValEl: earnVal,
          earnFillEl: earnFill,
          target: 0,
          cells: [],
          payable: [],
        };

        weekDays.forEach((date) => {
          const cell = document.createElement("div");
          cell.className = "cell";
          const ymd = ymdInNY(date);
          cell.dataset.ymd = ymd;

          const wd = date.getDay();
          const isWeekend = wd === 0 || wd === 6;
          const isHoliday = HOLIDAYS_ALL.has(ymd);
          const isPaidHoliday = PAID_DAYS.has(ymd);
          const withinWorkWindow = date <= workEnd;

          const circle = document.createElement("div");
          circle.className = "circle";
          circle.tabIndex = 0;

          let tip = fmtTooltip.format(date);
          if (isHoliday && isPaidHoliday) tip += " • Paid holiday";
          else if (isHoliday) tip += " • Unpaid holiday";
          circle.title = tip;

          const number = String(Number(fmtDay.format(date)));
          circle.textContent = number;
          circle.dataset.number = number;

          const dateLabel = document.createElement("div");
          dateLabel.className = "date";
          dateLabel.textContent = `${number} ${fmtMonth.format(date)}`;

          if (isHoliday) {
            cell.classList.add("holiday");
            circle.textContent = "✖";
            if (withinWorkWindow && isPaidHoliday) {
              model.payable.push(cell);
              payableCells.push(cell);
            }
          } else if (isWeekend) {
            cell.classList.add("weekend");
          } else {
            if (withinWorkWindow) {
              workdayCells.push(cell);
              model.payable.push(cell);
              payableCells.push(cell);
            }
          }

          cell.appendChild(circle);
          cell.appendChild(dateLabel);
          grid.appendChild(cell);

          model.cells.push(cell);
        });

        weekModels.push(model);
      });

      // Цели по неделям
      weekModels.forEach((m) => {
        const targetDays = m.payable.length;
        m.target = targetDays * DAILY_RATE;
        m.earnValEl.textContent = `$0 / $${m.target}`;
        m.earnFillEl.style.width = "0%";
      });

      const TOTAL_WORKDAYS = workdayCells.length;
      const TOTAL_PAYABLE = payableCells.length;
      const TOTAL_TARGET = TOTAL_PAYABLE * DAILY_RATE;

      function markToday() {
        document
          .querySelectorAll(".today")
          .forEach((el) => el.classList.remove("today"));
        const nyNow = nowInNY();
        const todayYMD = ymdInNY(nyNow);
        const todayCell = document.querySelector(
          `.cell[data-ymd="${todayYMD}"]`
        );
        if (todayCell) todayCell.classList.add("today");
      }

      function updateState() {
        const nyNow = nowInNY();
        const nyYMD = ymdInNY(nyNow);
        const hour = nyNow.getHours();

        let doneWorkdays = 0;
        let earnedTotal = 0;

        weekModels.forEach((m) => (m.earned = 0));

        workdayCells.forEach((cell) => {
          const ymd = cell.dataset.ymd;
          const circle = cell.querySelector(".circle");
          if (!circle) return;

          let isDone = false;
          if (ymd < nyYMD) isDone = true;
          else if (ymd === nyYMD && hour >= 17) isDone = true;

          if (isDone) {
            cell.classList.add("done");
            circle.textContent = "✔";
            doneWorkdays++;
          } else {
            cell.classList.remove("done");
            circle.textContent = circle.dataset.number;
          }
        });

        payableCells.forEach((cell) => {
          const ymd = cell.dataset.ymd;
          let credited = false;
          if (ymd < nyYMD) credited = true;
          else if (ymd === nyYMD && hour >= 17) credited = true;

          if (credited) {
            earnedTotal += DAILY_RATE;
            const weekModel = weekModels.find((m) => m.cells.includes(cell));
            if (weekModel)
              weekModel.earned = (weekModel.earned || 0) + DAILY_RATE;
          }
        });

        weekModels.forEach((m) => {
          const earned = Math.min(m.earned || 0, m.target);
          const pct = m.target ? Math.round((earned / m.target) * 100) : 0;
          m.earnValEl.textContent = `$${earned} / $${m.target}`;
          m.earnFillEl.style.width = pct + "%";
        });

        const pctTotal = TOTAL_WORKDAYS
          ? Math.round((doneWorkdays / TOTAL_WORKDAYS) * 100)
          : 0;
        barFill.style.width = pctTotal + "%";
        barFill.parentElement.setAttribute("aria-valuenow", String(pctTotal));
        progressNums.textContent = `${doneWorkdays}/${TOTAL_WORKDAYS} (${pctTotal}%)`;

        earnTotalEl.textContent = `Total earned: $${earnedTotal} / $${TOTAL_TARGET}`;

        markToday();
      }

      updateState();
      setInterval(updateState, 60_000);
    </script>
  </body>
</html>
